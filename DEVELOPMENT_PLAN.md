# Hotlapping Mod - План разработки

## Анализ BeamJoy компонентов

### Найденные полезные элементы для реализации

#### 1. Управление точками на карте (Waypoints)
- **`RaceWaypointManager.lua`** - Менеджер для работы с гоночными точками
  - Создание, удаление, модификация waypoints
  - Отслеживание прохождения через точки
  - Расчет позиций и дистанций
  
- **`WaypointEditManager.lua`** - Менеджер для редактирования точек на карте
  - UI для установки точек
  - Режим редактирования
  - Сохранение/загрузка конфигурации
  
- **`InteractiveMarkerManager.lua`** - Интерактивные маркеры
  - Визуализация точек в 3D пространстве
  - Взаимодействие с маркерами

#### 2. Отрисовка и визуализация
- **`ShapeDrawer.lua`** - Утилита для отрисовки форм
  - Рисование линий между точками
  - Отрисовка сфер (маркеры)
  - Цилиндры, стрелки и другие формы
  - Функции для визуализации checkpoint линий

#### 3. Детектирование пересечения линии
- Система проверки пересечения линии старт-финиш
- Алгоритмы расчета:
  - Позиция автомобиля относительно линии
  - Определение момента пересечения
  - Направление пересечения (чтобы не засчитывать движение назад)

#### 4. UI компоненты
- **`RaceUIManager.lua`** - UI для отображения информации о гонке
  - Текущее время круга
  - Лучшее время
  - Список предыдущих кругов
  - Позиция и статус
  
- **`ToastManager.lua`** - Всплывающие уведомления
- **`UIManager.lua`** - Базовый UI менеджер

#### 5. Хранение данных
- **`LocalStorageManager.lua`** - Локальное хранилище
  - Сохранение позиций точек старт-финиш
  - Хранение лучших времен
  - История кругов
  
- **`CacheManager.lua`** - Кэширование данных

#### 6. Утилиты
- **`MATH.lua`** - Математические функции
  - Расчет расстояний между точками
  - Векторные операции
  - Проекции и углы
  
- **`Table.lua`** - Операции с таблицами
- **`String.lua`** - Строковые функции
- **`Constants.lua`** - Константы

#### 7. Система сценариев
- **`ScenarioRaceSolo.lua`** - Пример реализации одиночной гонки
  - Логика запуска/остановки таймера
  - Обработка прохождения кругов
  - Подсчет времени

---

## Чек-лист реализации Hotlapping мода

### Этап 1: Базовая структура проекта ✅

#### 1.1 Создание файловой структуры ✅
- [x] Создать основную структуру папок:
  ```
  Hotlapping/
  ├── lua/
  │   └── ge/
  │       └── extensions/
  │           └── Hotlapping.lua (главный файл расширения)
  └── ui/
      └── modules/
          └── apps/
              └── hotlapping/
                  ├── app.html
                  ├── app.js
                  └── app.css
  └── mod_info.json
  ```

#### 1.2 Создание базовых файлов ✅
- [x] `mod_info.json` - Метаданные мода
- [x] `Hotlapping.lua` - Главный файл расширения
- [x] Базовая структура UI (HTML/JS/CSS)

#### 1.3 Регистрация расширения ✅
- [x] Функция `onExtensionLoaded()`
- [x] Функция `onExtensionUnloaded()`
- [x] Регистрация обработчиков событий

#### 1.4 UI концепция (реализовано) ✅
- [x] Две кнопки: "Установить точку А" и "Установить точку Б"
- [x] Строка статуса с состояниями:
  - "Не установлено"
  - "Точка А установлена, установите точку Б"
  - "Установлено"
  - "В процессе настройки точки А..."
  - "В процессе настройки точки Б..."
- [x] Кнопка "Очистить точки"
- [x] Визуальная индикация статуса (цвета)
- [x] Блокировка кнопки Б пока не установлена точка А

---

### Этап 2: Система управления точками (Waypoint System) ✅

#### 2.1 Модуль WaypointManager ✅
- [x] Создать `WaypointManager.lua` (упрощенная версия из BeamJoy)
- [x] Структура данных для хранения двух точек:
  - Point A (красная)
  - Point B (синяя)
- [x] Функции:
  - [x] `setPointA(position)` - установить точку A
  - [x] `setPointB(position)` - установить точку B
  - [x] `clearPoints()` - очистить обе точки
  - [x] `getFinishLine()` - получить линию старт-финиш
  - [x] `isLineConfigured()` - проверка наличия обеих точек
  - [x] `getLineLength()` - длина линии
  - [x] `getMidpoint()` - центр линии
  - [x] `serialize()/deserialize()` - сохранение/загрузка

#### 2.2 Визуализация точек ✅
- [x] Функция `drawVisualization()` для отрисовки
- [x] Функции отрисовки:
  - [x] Рисовать сферы в позициях точек (красная для A, синяя для B)
  - [x] Рисовать линию между точками (зеленая)
  - [x] Эффект толщины линии (параллельные линии)
  - [x] Клетчатый паттерн на финишной линии
  - [x] Текстовые метки "Point A" и "Point B"
- [x] Обновление визуализации каждый кадр (интегрировано в onUpdate)

#### 2.3 Режим установки точек ✅
- [x] Интеграция с главным модулем Hotlapping.lua
- [x] Установка точки A через кнопку UI
- [x] Установка точки B через кнопку UI  
- [x] Получение позиции из позиции автомобиля
- [x] Feedback пользователю через статус UI
- [x] Автоматическое обновление статуса конфигурации

---

### Этап 3: Детектор пересечения линии (Line Crossing Detector) ✅

#### 3.1 Модуль CrossingDetector ✅
- [x] Создать `CrossingDetector.lua`
- [x] Алгоритм определения пересечения линии:
  - [x] Хранить предыдущую позицию автомобиля
  - [x] При каждом обновлении проверять:
    - Пересекла ли траектория (prev → current) линию старт-финиш
  - [x] Использовать векторную математику (cross product)

#### 3.2 Математические функции ✅
- [x] Адаптировать нужные функции из `MATH.lua`:
  - [x] Проверка пересечения двух отрезков в 2D (игнорируем высоту)
  - [x] Определение стороны точки относительно линии
  - [x] Расчет расстояния до линии

#### 3.3 Определение направления ✅
- [x] Проверка направления пересечения
- [x] Засчитывать только пересечение в правильном направлении
- [x] Игнорировать движение задним ходом через линию

---

### Этап 4: Система таймера и учета кругов (Lap Timer System) ✅

#### 4.1 Модуль LapTimer ✅
- [x] Создать `LapTimer.lua`
- [x] Состояния таймера:
  - [x] Stopped (остановлен)
  - [x] Running (идет)
  - [x] Paused (пауза - опционально)
- [x] Функции:
  - [x] `startLap()` - начать новый круг
  - [x] `stopLap()` - завершить текущий круг
  - [x] `getCurrentTime()` - текущее время круга
  - [x] `reset()` - сбросить всё

#### 4.2 История кругов ✅
- [x] Структура данных для хранения завершенных кругов:
  ```lua
  {
    lapNumber = 1,
    time = 65.432,
    timestamp = "2025-10-18 14:30:00",
    vehicle = "etk800"
  }
  ```
- [x] Функции:
  - [x] `addLap(time)` - добавить завершенный круг
  - [x] `getLaps()` - получить все круги
  - [x] `getBestLap()` - получить лучший круг
  - [x] `clearHistory()` - очистить историю

#### 4.3 Форматирование времени ✅
- [x] Функция `formatTime(seconds)` - конвертация в MM:SS.mmm
- [x] Функция для расчета разницы времен (delta)

#### 4.4 Интеграция с UI ✅
- [x] Отображение текущего времени (обновление в реальном времени)
- [x] Отображение последнего круга
- [x] Отображение лучшего круга
- [x] История последних 5 кругов с подсветкой лучшего
- [x] Кнопка очистки истории

#### 4.5 Интеграция с CrossingDetector ✅
- [x] Автоматический старт первого круга при пересечении
- [x] Завершение круга и начало нового при пересечении
- [x] Уведомления о завершении круга
- [x] Уведомления о новом рекорде

#### 4.6 Обработка событий ✅
- [x] Сброс при смене автомобиля
- [x] Сброс при очистке точек
- [x] Отслеживание имени автомобиля в истории

---

### Этап 5: Локальное хранилище (Local Storage)

#### 5.1 Модуль StorageManager
- [ ] Создать `StorageManager.lua` (упрощенная версия из BeamJoy)
- [ ] Использовать BeamNG API для хранения:
  - `settings.setValue(key, value)`
  - `settings.getValue(key)`

#### 5.2 Сохраняемые данные
- [ ] Конфигурация линии старт-финиш:
  - Позиции точек (по карте/уровню)
  - Хранить отдельно для каждой карты
- [ ] История кругов:
  - Последние N кругов (например, 50)
  - Лучшее время для каждой карты
- [ ] Настройки мода:
  - Цвета маркеров
  - Размер UI
  - Включить/выключить визуализацию

#### 5.3 Функции сохранения/загрузки
- [ ] `saveFinishLine(mapName, point1, point2)` - сохранить линию
- [ ] `loadFinishLine(mapName)` - загрузить линию для текущей карты
- [ ] `saveLapHistory(mapName, laps)` - сохранить историю
- [ ] `loadLapHistory(mapName)` - загрузить историю
- [ ] Автосохранение после каждого круга

---

### Этап 6: Пользовательский интерфейс (UI)

#### 6.1 UI Layout
- [ ] Минималистичный дизайн
- [ ] Основные элементы:
  - [ ] Текущее время круга (большие цифры)
  - [ ] Лучшее время
  - [ ] Дельта относительно лучшего времени (+ или -)
  - [ ] Список последних кругов (топ-10)
  - [ ] Кнопки управления

#### 6.2 Кнопки управления
- [ ] "Set Point 1" - установить левую точку
- [ ] "Set Point 2" - установить правую точку
- [ ] "Clear Points" - очистить точки
- [ ] "Reset Lap" - сбросить текущий круг
- [ ] "Clear History" - очистить историю кругов
- [ ] Toggle UI (показать/скрыть)

#### 6.3 Визуальная обратная связь
- [ ] Цветовая индикация:
  - Зеленый - лучшее время побито
  - Желтый - близко к лучшему
  - Красный - медленнее обычного
- [ ] Уведомления:
  - "New best lap!"
  - "Point 1 set"
  - "Finish line configured"

#### 6.4 Адаптация компонентов из BeamJoy
- [ ] Адаптировать структуру UI из `RaceUIManager.lua`
- [ ] Использовать ImGui или CEF (в зависимости от подхода)

---

### Этап 7: Интеграция и главный контроллер

#### 7.1 Главный файл Hotlapping.lua
- [ ] Инициализация всех модулей:
  - WaypointManager
  - CrossingDetector
  - LapTimer
  - StorageManager
  - UI
- [ ] Координация работы модулей

#### 7.2 Игровой цикл (Update Loop)
- [ ] Функция `onUpdate(dt)`:
  - [ ] Получить текущую позицию автомобиля
  - [ ] Проверить пересечение линии старт-финиш
  - [ ] Обновить таймер
  - [ ] Обновить UI
  - [ ] Отрисовать визуализацию точек

#### 7.3 Обработка событий
- [ ] `onVehicleSwitched()` - смена автомобиля
- [ ] `onClientStartMission()` - загрузка карты
- [ ] `onClientEndMission()` - выход с карты
- [ ] Сохранение данных при выходе

---

### Этап 8: Тестирование и отладка

#### 8.1 Базовое тестирование
- [ ] Установка точек работает корректно
- [ ] Линия отрисовывается правильно
- [ ] Детектор пересечения срабатывает точно
- [ ] Таймер работает без задержек
- [ ] Сохранение/загрузка работает

#### 8.2 Граничные случаи
- [ ] Движение задним ходом через линию (не должно засчитываться)
- [ ] Телепортация автомобиля
- [ ] Смена автомобиля во время круга
- [ ] Респавн автомобиля
- [ ] Отсутствие настроенной линии старт-финиш

#### 8.3 Производительность
- [ ] Проверить FPS при работе мода
- [ ] Оптимизировать частоту обновления визуализации
- [ ] Убедиться, что нет утечек памяти

---

### Этап 9: Полировка и улучшения

#### 9.1 Дополнительные фичи (опционально)
- [ ] Экспорт истории кругов в CSV/JSON
- [ ] Призрачный автомобиль (ghost car) лучшего круга
- [ ] Разделение на секторы (несколько промежуточных точек)
- [ ] Сравнение времен по секторам
- [ ] Статистика (средняя скорость, топ-скорость на круге)

#### 9.2 Настройки
- [ ] Меню настроек в UI
- [ ] Кастомизация цветов маркеров и линии
- [ ] Размер UI элементов
- [ ] Горячие клавиши

#### 9.3 Документация
- [ ] README.md с инструкцией по установке
- [ ] Руководство пользователя
- [ ] Комментарии в коде

---

## Технические детали

### Используемые BeamNG API
```lua
-- Позиция автомобиля
obj:getPosition()

-- Отрисовка форм
debugDrawer:drawSphere()
debugDrawer:drawLine()
debugDrawer:drawCylinder()

-- Сохранение данных
settings.setValue(key, value)
settings.getValue(key)

-- Время
os.time()
os.clock()

-- UI
guihooks.trigger()
```

### Структура данных

#### Finish Line
```lua
finishLine = {
    point1 = {x = 100, y = 200, z = 50},
    point2 = {x = 150, y = 200, z = 50},
    mapName = "west_coast_usa"
}
```

#### Lap Record
```lua
lap = {
    number = 5,
    time = 65.432,
    timestamp = 1729260000,
    vehicle = "etk800",
    isBest = false
}
```

---

## Приоритеты разработки

### MVP (Minimum Viable Product)
1. ✅ Установка двух точек
2. ✅ Визуализация линии
3. ✅ Детектор пересечения
4. ✅ Базовый таймер
5. ✅ Простейший UI с текущим временем

### Версия 1.0
- Сохранение/загрузка точек
- История кругов
- Лучшее время
- Полноценный UI

### Будущие улучшения
- Секторы
- Призрак
- Статистика
- Экспорт данных

---

## Примечания

- Начинаем с клиентской части (Client-side only)
- Мод работает только для локального игрока
- Фокус на простоте и производительности
- Минимальные зависимости от BeamJoy (берем только идеи и подходы)
- Код должен быть чистым и хорошо документированным

---

*Дата создания: 18 октября 2025*
*Версия документа: 1.0*
