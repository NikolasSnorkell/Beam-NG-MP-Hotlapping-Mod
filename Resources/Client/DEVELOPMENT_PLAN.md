# Hotlapping Mod - План разработки

## Анализ BeamJoy компонентов

### Найденные полезные элементы для реализации

#### 1. Управление точками на карте (Waypoints)
- **`RaceWaypointManager.lua`** - Менеджер для работы с гоночными точками
  - Создание, удаление, модификация waypoints
  - Отслеживание прохождения через точки
  - Расчет позиций и дистанций
  
- **`WaypointEditManager.lua`** - Менеджер для редактирования точек на карте
  - UI для установки точек
  - Режим редактирования
  - Сохранение/загрузка конфигурации
  
- **`InteractiveMarkerManager.lua`** - Интерактивные маркеры
  - Визуализация точек в 3D пространстве
  - Взаимодействие с маркерами

#### 2. Отрисовка и визуализация
- **`ShapeDrawer.lua`** - Утилита для отрисовки форм
  - Рисование линий между точками
  - Отрисовка сфер (маркеры)
  - Цилиндры, стрелки и другие формы
  - Функции для визуализации checkpoint линий

#### 3. Детектирование пересечения линии
- Система проверки пересечения линии старт-финиш
- Алгоритмы расчета:
  - Позиция автомобиля относительно линии
  - Определение момента пересечения
  - Направление пересечения (чтобы не засчитывать движение назад)

#### 4. UI компоненты
- **`RaceUIManager.lua`** - UI для отображения информации о гонке
  - Текущее время круга
  - Лучшее время
  - Список предыдущих кругов
  - Позиция и статус
  
- **`ToastManager.lua`** - Всплывающие уведомления
- **`UIManager.lua`** - Базовый UI менеджер

#### 5. Хранение данных
- **`LocalStorageManager.lua`** - Локальное хранилище
  - Сохранение позиций точек старт-финиш
  - Хранение лучших времен
  - История кругов
  
- **`CacheManager.lua`** - Кэширование данных

#### 6. Утилиты
- **`MATH.lua`** - Математические функции
  - Расчет расстояний между точками
  - Векторные операции
  - Проекции и углы
  
- **`Table.lua`** - Операции с таблицами
- **`String.lua`** - Строковые функции
- **`Constants.lua`** - Константы

#### 7. Система сценариев
- **`ScenarioRaceSolo.lua`** - Пример реализации одиночной гонки
  - Логика запуска/остановки таймера
  - Обработка прохождения кругов
  - Подсчет времени

---

## Чек-лист реализации Hotlapping мода

### Этап 1: Базовая структура проекта ✅

#### 1.1 Создание файловой структуры ✅
- [x] Создать основную структуру папок:
  ```
  Hotlapping/
  ├── lua/
  │   └── ge/
  │       └── extensions/
  │           └── Hotlapping.lua (главный файл расширения)
  └── ui/
      └── modules/
          └── apps/
              └── hotlapping/
                  ├── app.html
                  ├── app.js
                  └── app.css
  └── mod_info.json
  ```

#### 1.2 Создание базовых файлов ✅
- [x] `mod_info.json` - Метаданные мода
- [x] `Hotlapping.lua` - Главный файл расширения
- [x] Базовая структура UI (HTML/JS/CSS)

#### 1.3 Регистрация расширения ✅
- [x] Функция `onExtensionLoaded()`
- [x] Функция `onExtensionUnloaded()`
- [x] Регистрация обработчиков событий

#### 1.4 UI концепция (реализовано) ✅
- [x] Две кнопки: "Установить точку А" и "Установить точку Б"
- [x] Строка статуса с состояниями:
  - "Не установлено"
  - "Точка А установлена, установите точку Б"
  - "Установлено"
  - "В процессе настройки точки А..."
  - "В процессе настройки точки Б..."
- [x] Кнопка "Очистить точки"
- [x] Визуальная индикация статуса (цвета)
- [x] Блокировка кнопки Б пока не установлена точка А

---

### Этап 2: Система управления точками (Waypoint System) ✅

#### 2.1 Модуль WaypointManager ✅
- [x] Создать `WaypointManager.lua` (упрощенная версия из BeamJoy)
- [x] Структура данных для хранения двух точек:
  - Point A (красная)
  - Point B (синяя)
- [x] Функции:
  - [x] `setPointA(position)` - установить точку A
  - [x] `setPointB(position)` - установить точку B
  - [x] `clearPoints()` - очистить обе точки
  - [x] `getFinishLine()` - получить линию старт-финиш
  - [x] `isLineConfigured()` - проверка наличия обеих точек
  - [x] `getLineLength()` - длина линии
  - [x] `getMidpoint()` - центр линии
  - [x] `serialize()/deserialize()` - сохранение/загрузка

#### 2.2 Визуализация точек ✅
- [x] Функция `drawVisualization()` для отрисовки
- [x] Функции отрисовки:
  - [x] Рисовать сферы в позициях точек (красная для A, синяя для B)
  - [x] Рисовать линию между точками (зеленая)
  - [x] Эффект толщины линии (параллельные линии)
  - [x] Клетчатый паттерн на финишной линии
  - [x] Текстовые метки "Point A" и "Point B"
- [x] Обновление визуализации каждый кадр (интегрировано в onUpdate)

#### 2.3 Режим установки точек ✅
- [x] Интеграция с главным модулем Hotlapping.lua
- [x] Установка точки A через кнопку UI
- [x] Установка точки B через кнопку UI  
- [x] Получение позиции из позиции автомобиля
- [x] Feedback пользователю через статус UI
- [x] Автоматическое обновление статуса конфигурации

---

### Этап 3: Детектор пересечения линии (Line Crossing Detector) ✅

#### 3.1 Модуль CrossingDetector ✅
- [x] Создать `CrossingDetector.lua`
- [x] Алгоритм определения пересечения линии:
  - [x] Хранить предыдущую позицию автомобиля
  - [x] При каждом обновлении проверять:
    - Пересекла ли траектория (prev → current) линию старт-финиш
  - [x] Использовать векторную математику (cross product)

#### 3.2 Математические функции ✅
- [x] Адаптировать нужные функции из `MATH.lua`:
  - [x] Проверка пересечения двух отрезков в 2D (игнорируем высоту)
  - [x] Определение стороны точки относительно линии
  - [x] Расчет расстояния до линии

#### 3.3 Определение направления ✅
- [x] Проверка направления пересечения
- [x] Засчитывать только пересечение в правильном направлении
- [x] Игнорировать движение задним ходом через линию

---

### Этап 4: Система таймера и учета кругов (Lap Timer System) ✅

#### 4.1 Модуль LapTimer ✅
- [x] Создать `LapTimer.lua`
- [x] Состояния таймера:
  - [x] Stopped (остановлен)
  - [x] Running (идет)
  - [x] Paused (пауза - опционально)
- [x] Функции:
  - [x] `startLap()` - начать новый круг
  - [x] `stopLap()` - завершить текущий круг
  - [x] `getCurrentTime()` - текущее время круга
  - [x] `reset()` - сбросить всё

#### 4.2 История кругов ✅
- [x] Структура данных для хранения завершенных кругов:
  ```lua
  {
    lapNumber = 1,
    time = 65.432,
    timestamp = "2025-10-18 14:30:00",
    vehicle = "etk800"
  }
  ```
- [x] Функции:
  - [x] `addLap(time)` - добавить завершенный круг
  - [x] `getLaps()` - получить все круги
  - [x] `getBestLap()` - получить лучший круг
  - [x] `clearHistory()` - очистить историю

#### 4.3 Форматирование времени ✅
- [x] Функция `formatTime(seconds)` - конвертация в MM:SS.mmm
- [x] Функция для расчета разницы времен (delta)

#### 4.4 Интеграция с UI ✅
- [x] Отображение текущего времени (обновление в реальном времени)
- [x] Отображение последнего круга
- [x] Отображение лучшего круга
- [x] История последних 5 кругов с подсветкой лучшего
- [x] Кнопка очистки истории

#### 4.5 Интеграция с CrossingDetector ✅
- [x] Автоматический старт первого круга при пересечении
- [x] Завершение круга и начало нового при пересечении
- [x] Уведомления о завершении круга
- [x] Уведомления о новом рекорде

#### 4.6 Обработка событий ✅
- [x] Сброс при смене автомобиля
- [x] Сброс при очистке точек
- [x] Отслеживание имени автомобиля в истории

---

### Этап 5: Локальное хранилище (Local Storage) ✅

#### 5.1 Модуль StorageManager ✅
- [x] Создать `StorageManager.lua` (упрощенная версия из BeamJoy)
- [x] Использовать BeamNG API для хранения:
  - `settings.setValue(key, value)`
  - `settings.getValue(key)`

#### 5.2 Сохраняемые данные ✅
- [x] Конфигурация линии старт-финиш:
  - Позиции точек (по карте/уровню)
  - Хранить отдельно для каждой карты
- [x] История кругов:
  - Последние N кругов (например, 100)
  - Лучшее время для каждой карты
- [x] Настройки мода:
  - Базовая структура для будущих настроек
  - API для сохранения/загрузки настроек

#### 5.3 Функции сохранения/загрузки ✅
- [x] `saveFinishLine(pointA, pointB, mapName)` - сохранить линию
- [x] `loadFinishLine(mapName)` - загрузить линию для текущей карты
- [x] `saveLapHistory(laps, mapName)` - сохранить историю
- [x] `loadLapHistory(mapName)` - загрузить историю
- [x] Автосохранение после каждого круга
- [x] Автосохранение при установке точек
- [x] Автозагрузка при загрузке карты
- [x] Экспорт/импорт истории в JSON файлы

---

### Этап 6: BeamMP интеграция - Синхронизация точек старт-финиш

#### 6.1 Архитектура клиент-сервер
- [ ] **Клиентская часть** (`hotlapping_beammp.lua`):
  - [ ] Проверка доступности `MPGameNetwork` для определения BeamMP режима
  - [ ] Отправка позиций точек на сервер при установке
  - [ ] Получение позиций точек от сервера при подключении
  - [ ] Fallback на локальное хранилище в оффлайн режиме
  
- [ ] **Серверная часть** (lua плагин BeamMP):
  - [ ] Хранение конфигурации точек для каждой карты
  - [ ] Синхронизация точек с подключающимися игроками
  - [ ] Обработка установки/изменения точек от клиентов
  - [ ] JSON файл для персистентного хранения: `waypoints_data.json`

#### 6.2 Формат данных
```json
{
  "west_coast_usa": {
    "pointA": {"x": 100.5, "y": 200.3, "z": 50.1},
    "pointB": {"x": 150.2, "y": 200.8, "z": 50.3}
  },
  "italy": {
    "pointA": {...},
    "pointB": {...}
  }
}
```

#### 6.3 Проверки и режимы работы
- [ ] Функция `isBeamMPAvailable()` - проверка доступности BeamMP
- [ ] Режим работы:
  - **Онлайн**: Синхронизация с сервером, локальное хранилище как fallback
  - **Оффлайн**: Только локальное хранилище
- [ ] Автоматическое определение режима при загрузке

#### 6.4 Сетевые функции (клиент)
- [ ] `sendWaypointsToServer(mapName, pointA, pointB)` - отправка точек
- [ ] `requestWaypointsFromServer(mapName)` - запрос точек при подключении
- [ ] `onWaypointsReceived(data)` - обработка полученных точек
- [ ] Обработка ошибок сети и таймаутов

#### 6.5 Серверные функции
- [ ] `loadWaypointsFromFile()` - загрузка из JSON при старте сервера
- [ ] `saveWaypointsToFile()` - сохранение в JSON
- [ ] `onClientWaypointsUpdate(playerID, data)` - обработка обновления от клиента
- [ ] `sendWaypointsToClient(playerID, mapName)` - отправка точек клиенту
- [ ] `onPlayerJoin(playerID)` - автоотправка точек при подключении

#### 6.6 Права и безопасность
- [ ] Опционально: ограничение изменения точек (только админы)
- [ ] Валидация данных от клиентов (проверка координат)
- [ ] Защита от спама обновлениями

---

### Этап 7: BeamMP интеграция - Лидерборд времен

#### 7.1 Архитектура лидерборда

**Решение: Отображать только лучшее время каждого игрока**

**Преимущества:**
- Меньше сетевого трафика
- Легче хранить и обрабатывать
- Более честная конкуренция (каждый улучшает свой результат)
- Проще UI (компактный список)

**Недостатки:**
- Не видно прогресс других игроков в реальном времени
- Менее динамично

**Альтернатива (опционально в будущем):**
- Режим "Live tracking" - показывать последние 3 круга каждого игрока
- Переключение режимов через UI

#### 7.2 Формат данных лидерборда
```json
{
  "west_coast_usa": {
    "leaderboard": [
      {
        "playerName": "NikolasSnorkell",
        "playerID": 1,
        "bestTime": 65.432,
        "vehicle": "etk800",
        "timestamp": "2025-10-19 15:30:00"
      },
      {
        "playerName": "PlayerTwo",
        "playerID": 2,
        "bestTime": 67.123,
        "vehicle": "sunburst",
        "timestamp": "2025-10-19 15:25:00"
      }
    ]
  }
}
```

#### 7.3 Клиентская часть лидерборда
- [ ] Отправка лучшего времени на сервер при завершении круга (только если улучшен)
- [ ] Функция `sendLapTimeToServer(mapName, time, vehicle)` 
- [ ] Получение обновленного лидерборда от сервера
- [ ] Функция `onLeaderboardUpdate(data)` - обновление локального лидерборда
- [ ] Кэширование лидерборда локально

#### 7.4 Серверная часть лидерборда
- [ ] Файл `leaderboard_data.json` для хранения
- [ ] `loadLeaderboardFromFile()` - загрузка при старте сервера
- [ ] `saveLeaderboardToFile()` - периодическое сохранение
- [ ] `updatePlayerBestTime(playerID, mapName, time, vehicle)` - обновление рекорда
- [ ] `broadcastLeaderboardUpdate(mapName)` - рассылка обновлений всем игрокам
- [ ] Сортировка лидерборда по времени (лучшие сверху)
- [ ] Ограничение количества записей (топ-100)

#### 7.5 UI окно лидерборда
- [ ] Отдельное окно ImGui "Leaderboard"
- [ ] Кнопка переключения видимости лидерборда
- [ ] Отображение:
  - Место (1, 2, 3...)
  - Имя игрока
  - Лучшее время
  - Автомобиль
  - Дельта от лидера (+X.XXX)
  - Дата установки рекорда
- [ ] Подсветка своей позиции в списке
- [ ] Цветовая индикация топ-3 (золото, серебро, бронза)
- [ ] Автообновление при получении данных
- [ ] Возможность сворачивания/разворачивания

#### 7.6 Оптимизация сетевого трафика
- [ ] **Важно:** Отправка только лучшего времени (не каждого круга)
- [ ] Отправка только при улучшении личного рекорда
- [ ] Throttling обновлений лидерборда (не чаще раз в 5 секунд)
- [ ] Сжатие JSON данных при передаче
- [ ] Batch обновления (группировка нескольких изменений)

#### 7.7 События и уведомления
- [ ] Уведомление при улучшении личного рекорда
- [ ] Уведомление когда кто-то побил общий рекорд (всем игрокам)
- [ ] Уведомление при попадании в топ-10
- [ ] Опция отключения уведомлений в настройках

---

### Этап 8: Настройки и Debug режим

#### 8.1 Debug визуализация
- [ ] Галочка "Debug Mode" в UI
- [ ] Отображение/скрытие визуальных элементов:
  - [ ] Линия старт-финиш (зеленая с шахматным паттерном)
  - [ ] Сферы точек A и B (красная и синяя)
  - [ ] Линии диагоналей автомобиля (из CrossingDetector)
  - [ ] Сферы углов автомобиля
- [ ] Сохранение состояния Debug режима в настройках
- [ ] Клавиша быстрого переключения (например, Ctrl+D)

#### 8.2 Настройки визуализации
- [ ] Размер сфер точек (слайдер 0.1 - 2.0)
- [ ] Толщина линии финиша
- [ ] Высота визуализации над землей
- [ ] Прозрачность элементов
- [ ] Цвета (выбор цвета для точек и линии)

#### 8.3 Настройки UI
- [ ] Масштаб UI (слайдер 0.8 - 1.5)
- [ ] Положение окон (сохранение позиции)
- [ ] Автоскрытие UI при движении
- [ ] Прозрачность окон

#### 8.4 Игровые настройки
- [ ] Автоматический старт круга при пересечении
- [ ] Звуковые уведомления
- [ ] Формат времени (MM:SS.mmm или SS.mmm)
- [ ] Количество отображаемых кругов в истории

---

### Этап 9: Интеграция и главный контроллер

#### 9.1 Главный файл hotlapping_beammp.lua
- [x] Инициализация всех модулей:
  - [x] WaypointManager
  - [x] CrossingDetector
  - [x] LapTimer
  - [ ] StorageManager
  - [x] UI (ImGui)
- [x] Координация работы модулей

#### 9.2 Игровой цикл (Update Loop)
- [x] Функция `onUpdate(dt)`:
  - [x] Получить текущую позицию автомобиля
  - [x] Проверить пересечение линии старт-финиш
  - [x] Обновить таймер
  - [x] Обновить UI (в onPreRender)
  - [x] Отрисовать визуализацию точек

#### 9.3 Обработка событий
- [x] `onVehicleSwitched()` - смена автомобиля
- [x] `onClientStartMission()` - загрузка карты
- [x] `onClientEndMission()` - выход с карты
- [ ] Сохранение данных при выходе

---

### Этап 10: Тестирование и отладка

#### 10.1 Базовое тестирование
- [x] Установка точек работает корректно
- [x] Линия отрисовывается правильно
- [x] Детектор пересечения срабатывает точно
- [x] Таймер работает без задержек
- [ ] Сохранение/загрузка работает
- [ ] BeamMP синхронизация работает

#### 10.2 Граничные случаи
- [x] Движение задним ходом через линию (не должно засчитываться)
- [x] Телепортация автомобиля
- [x] Смена автомобиля во время круга
- [x] Респавн автомобиля
- [x] Отсутствие настроенной линии старт-финиш
- [ ] Потеря соединения с сервером BeamMP
- [ ] Конфликт установки точек несколькими игроками

#### 10.3 Производительность
- [x] Проверить FPS при работе мода
- [x] Оптимизировать частоту обновления визуализации
- [ ] Убедиться, что нет утечек памяти
- [ ] Тестирование сетевой нагрузки в BeamMP

#### 10.4 BeamMP тестирование
- [ ] Синхронизация точек между клиентами
- [ ] Обновление лидерборда в реальном времени
- [ ] Подключение нового игрока (получение данных)
- [ ] Работа в оффлайн режиме (fallback на локальное хранилище)
- [ ] Множественные карты
- [ ] Несколько игроков одновременно улучшают рекорды

---

### Этап 11: Полировка и улучшения

#### 11.1 Дополнительные фичи (опционально)
- [ ] Экспорт истории кругов в CSV/JSON
- [ ] Призрачный автомобиль (ghost car) лучшего круга
- [ ] Разделение на секторы (несколько промежуточных точек)
- [ ] Сравнение времен по секторам
- [ ] Статистика (средняя скорость, топ-скорость на круге)
- [ ] Голосовые уведомления
- [ ] Интеграция с Discord (вебхуки для новых рекордов)

#### 11.2 Настройки
- [x] Меню настроек в UI (частично реализовано через ImGui)
- [ ] Кастомизация цветов маркеров и линии
- [ ] Размер UI элементов
- [ ] Горячие клавиши

#### 11.3 Документация
- [x] README.md с инструкцией по установке
- [x] Руководство пользователя (частично)
- [x] Комментарии в коде
- [ ] Документация BeamMP серверной части
- [ ] Видео-туториал (опционально)

---

## Технические детали

### Используемые BeamNG API
```lua
-- Позиция автомобиля
obj:getPosition()

-- Отрисовка форм
debugDrawer:drawSphere()
debugDrawer:drawLine()
debugDrawer:drawCylinder()

-- Сохранение данных
settings.setValue(key, value)
settings.getValue(key)

-- Время
os.time()
os.clock()

-- UI
guihooks.trigger()
```

### Структура данных

#### Finish Line
```lua
finishLine = {
    point1 = {x = 100, y = 200, z = 50},
    point2 = {x = 150, y = 200, z = 50},
    mapName = "west_coast_usa"
}
```

#### Lap Record
```lua
lap = {
    number = 5,
    time = 65.432,
    timestamp = 1729260000,
    vehicle = "etk800",
    isBest = false
}
```

---

## Приоритеты разработки (Обновлено 19.10.2025)

### MVP (Minimum Viable Product) - ✅ Завершено
1. ✅ Установка двух точек
2. ✅ Визуализация линии
3. ✅ Детектор пересечения
4. ✅ Базовый таймер
5. ✅ Простейший UI с текущим временем
6. ✅ История кругов и лучшее время

### Версия 1.0 - Локальное хранилище и BeamMP (Текущая цель)
**Этап 5: LocalStorage** ✅ ЗАВЕРШЕНО (19.10.2025)
- [x] Сохранение/загрузка точек по картам
- [x] Сохранение истории кругов по картам
- [x] Автозагрузка при старте карты
- [x] Экспорт/импорт данных
- [x] Автосохранение после каждого круга
- [x] Удаление данных при очистке точек/истории

**Этап 6: BeamMP - Синхронизация точек** (Следующий)
- [ ] Проверка `MPGameNetwork.launcherConnected()`
- [ ] Система админов (admins.json)
- [ ] Синхронизация точек между клиентами
- [ ] Серверный плагин
- [ ] Условное отображение UI кнопок (админ/игрок)

**Этап 7: BeamMP - Лидерборд с вкладками**

#### 7.1 Проверка статуса мультиплеера
- [ ] Реализовать функцию `isInMP()` для проверки `(MP ~= nil)`
- [ ] Добавить логику условного отображения функционала отправки времен только в MP режиме
- [ ] Интегрировать fallback поведение для соло режима

#### 7.2 Структура данных лидерборда
- [ ] Создать локальные структуры для хранения последних 3 кругов каждого игрока (total)
- [ ] Создать структуры для лучших времен каждого игрока (best)
- [ ] Подготовить JSON формат для серверного обмена данными
- [ ] Реализовать функции обновления локальных данных

#### 7.3 ImGui окно с вкладками
- [ ] Создать новое ImGui окно "Server Leaderboard"
- [ ] Реализовать две вкладки: "Best Times" и "Recent Times"
- [ ] Использовать `BeginTabBar/EndTabBar` и `BeginTabItem/EndTabItem` как в BeamJoy
- [ ] Добавить переключение между вкладками с сохранением состояния

#### 7.4 Отправка времен на сервер
- [ ] При завершении круга в MP режиме отправлять время на сервер
- [ ] Добавить отметку `isBest: true/false` если это лучший круг игрока
- [ ] Использовать BeamMP API (TriggerServerEvent или аналогичный) для передачи JSON
- [ ] Реализовать throttling отправки (не чаще раза в несколько секунд)

#### 7.5 Обработчики серверных событий
- [ ] Добавить функцию `onServerDataReceived()` для получения обновлений лидерборда
- [ ] Реализовать парсинг JSON данных от сервера
- [ ] Обновление локального лидерборда при получении новых данных
- [ ] Добавить обработку ошибок сети и невалидных данных

#### 7.6 Интеграция в основной UI
- [ ] Добавить кнопку "Show/Hide Leaderboard" в основное окно
- [ ] Реализовать функции `showLeaderboard/hideLeaderboard`
- [ ] Сохранять состояние видимости лидерборда в настройках
- [ ] Добавить индикатор статуса подключения к серверу

#### 7.7 Тестирование универсальности
- [ ] Протестировать корректную работу в соло режиме (функции отправки не вызываются)
- [ ] Убедиться что лидерборд показывает соответствующее сообщение в оффлайн
- [ ] Протестировать переключение между MP и Solo режимами
- [ ] Проверить работу при потере соединения с сервером

**Этап 8: Debug режим**
- [ ] Галочка Debug в UI
- [ ] Управление визуализацией
- [ ] Сохранение настройки

### Версия 1.5 - Улучшения (После v1.0)
- [ ] Экспорт/импорт истории
- [ ] Дополнительные настройки визуализации
- [ ] Горячие клавиши
- [ ] Оптимизация производительности

### Версия 2.0 - Расширенный функционал (Будущее)
- [ ] Режим "Recent laps" в лидерборде
- [ ] Множественные треки на карте
- [ ] Звуковые уведомления (референс из Chases_Mode)
- [ ] Секторы (промежуточные точки)
- [ ] Призрак лучшего круга
- [ ] Расширенная статистика (G-силы, скорости)
- [ ] Интеграция с Discord (вебхуки)

---

## Вопросы для обсуждения

### 1. Права на изменение точек в BeamMP ✅ РЕШЕНО
**Решение:** Только администраторы из списка

**Реализация:**
- Список админов хранится в `admins.json` на сервере
- Проверка по никнейму игрока (`MP.GetPlayerName(playerID)`)
- Клиент получает информацию о правах при подключении
- UI автоматически скрывает/показывает кнопки установки точек

**Структура admins.json:**
```json
{
  "admins": [
    "NikolasSnorkell",
    "AdminNickname2",
    "ModeratorName"
  ]
}
```

**Логика:**
- При подключении игрока сервер проверяет его никнейм
- Отправляет клиенту флаг `isAdmin: true/false`
- Клиент показывает/скрывает блок с кнопками установки точек
- Обычные игроки видят только установленные точки и могут ездить

### 2. Режимы лидерборда ✅ РЕШЕНО
**Решение:** Поэтапная реализация

**MVP (v1.0):**
- Только лучшее время каждого игрока
- Простой список с сортировкой
- Топ-100 игроков

**Будущие улучшения (v2.0):**
- Режим "Recent laps" - последние N кругов каждого игрока
- Live tracking текущих попыток
- Фильтры и дополнительная статистика

**Приоритет:** Сначала базовый функционал, расширения потом

### 3. Уведомления и звуки ✅ РЕШЕНО
**Решение:** Минимальные уведомления в MVP, звуки в будущем

**MVP (v1.0):**
- Текстовые уведомления в UI при завершении круга (только для игрока)
- Подсветка нового рекорда в истории
- Без глобальных уведомлений в чат

**Будущие улучшения (v2.0+):**
- Звук при пересечении финишной линии
- Звук при новом личном рекорде
- Можно использовать референсы из Chases_Mode
- Опциональные уведомления в чат о мировых рекордах

**Приоритет:** Звуки - низкий, сначала основной функционал

### 4. Хранение истории кругов ✅ РЕШЕНО
**Решение:** Локальное хранение личной истории

**MVP (v1.0):**
- **Локально на клиенте:** Полная история кругов игрока
- **На сервере:** Только лучшее время для лидерборда
- Сохранение в JSON по картам

**Преимущества:**
- ✅ Минимальная нагрузка на сервер
- ✅ Нет лишнего сетевого трафика
- ✅ Приватность данных игрока
- ✅ Работает в оффлайн режиме

**Будущие возможности (опционально):**
- Экспорт/импорт личной истории
- Синхронизация между устройствами (облако)
- Серверная аналитика (агрегированная статистика)

### 5. Множественные треки на одной карте ✅ РЕШЕНО
**Решение:** Будущая фича, держим в уме при проектировании

**MVP (v1.0):**
- Одна конфигурация точек на карту
- Простое хранилище `{mapName: {pointA, pointB}}`

**Архитектурная подготовка:**
- Структура данных должна допускать расширение
- Формат JSON планируем так, чтобы потом легко добавить треки

**Будущая реализация (v2.0+):**
```json
{
  "west_coast_usa": {
    "tracks": {
      "highway_sprint": {
        "name": "Highway Sprint",
        "pointA": {...},
        "pointB": {...}
      },
      "mountain_road": {
        "name": "Mountain Road",
        "pointA": {...},
        "pointB": {...}
      }
    },
    "activeTrack": "highway_sprint"
  }
}
```

**Сложность:** Средняя-высокая (UI выбора треков, синхронизация, лидерборды)
**Приоритет:** Низкий, после MVP

### 6. Валидация времен (античит) ✅ РЕШЕНО
**Решение:** Не требуется в текущей версии

**MVP (v1.0):**
- Доверие игрокам
- Базовая валидация на сервере (проверка разумности значений)
- Максимальное время круга (например, < 1 час)
- Минимальное время круга (например, > 5 секунд)

**Обоснование:**
- Игра не competitive e-sport
- Сообщество обычно дружелюбное
- Сложная валидация требует больших ресурсов
- Админы могут вручную модерировать лидерборд

**Будущие возможности (если потребуется):**
- Логирование подозрительных результатов
- Флаги для ручной проверки админами
- Базовая проверка средней скорости
- Система репортов от игроков

### 7. Персональная история в BeamMP ✅ РЕШЕНО
**Решение:** Локальное хранение с возможностью экспорта

**Реализация:**
- История кругов хранится локально на клиенте
- Сохранение в JSON файл в папке мода
- Не теряется между сессиями игры
- Не синхронизируется между устройствами

**Преимущества:**
- ✅ Нет нагрузки на сервер
- ✅ Быстрая работа
- ✅ Приватность данных
- ✅ Работает оффлайн

**Дополнительно (v1.5+):**
- Функция экспорта истории в файл
- Функция импорта истории
- Позволит переносить данные между установками

**Формат хранения:**
```json
{
  "west_coast_usa": {
    "laps": [
      {
        "lapNumber": 1,
        "time": 65.432,
        "timestamp": "2025-10-19 15:30:00",
        "vehicle": "etk800"
      },
      // ...последние 100 кругов
    ],
    "bestTime": 65.432
  }
}
```

---

## Технические детали реализации BeamMP

### Архитектура взаимодействия клиент-сервер

```
[Клиент 1]          [Сервер BeamMP]          [Клиент 2]
    |                       |                       |
    |-- Set Point A ------->|                       |
    |-- Set Point B ------->|                       |
    |                       |-- Save to JSON        |
    |                       |-- Broadcast Points -->|
    |                       |                       |-- Apply Points
    |                       |                       |
    |                       |<-- Join Event --------|
    |                       |-- Send Points ------->|
    |                       |                       |-- Apply Points
    |                       |                       |
    |-- Complete Lap ------>|                       |
    |   (Best: 65.432s)     |-- Update Leaderboard  |
    |                       |-- Broadcast Update -->|
    |<-- Leaderboard -------|                       |-- Update UI
```

### Проверка BeamMP режима (клиент)

```lua
local function isBeamMPAvailable()
    -- Проверяем наличие MPGameNetwork API
    if MPGameNetwork and type(MPGameNetwork.launcherConnected) == "function" then
        return MPGameNetwork.launcherConnected()
    end
    return false
end

local function getOperationMode()
    if isBeamMPAvailable() then
        return "online"  -- BeamMP multiplayer
    else
        return "offline" -- Singleplayer or no BeamMP
    end
end
```

### Система прав доступа (клиент)

```lua
local isAdmin = false  -- Флаг прав админа

-- Обработка информации о правах от сервера
local function onAdminStatusReceived(adminStatus)
    isAdmin = adminStatus
    log(string.format("Admin status: %s", tostring(isAdmin)))
    
    -- UI автоматически обновится в onPreRender
end

-- В onPreRender при отрисовке UI
local function onPreRender(dt)
    -- ... другой UI ...
    
    -- Блок управления точками (показываем только админам в BeamMP)
    local showWaypointControls = true
    if isBeamMPAvailable() and not isAdmin then
        showWaypointControls = false
    end
    
    if showWaypointControls then
        im.Separator()
        im.Text("Управление точками (Админ)")
        
        if im.Button("Установить точку А", im.ImVec2(250, 30)) then
            setPointA()
        end
        
        -- ... остальные кнопки ...
    end
    
    -- Статус и таймер показываем всем
    im.Separator()
    im.Text("Текущий круг:")
    -- ...
end
```

### Отправка данных на сервер (клиент)

Используя подход BeamJoy с TriggerServerEvent:

```lua
local function sendWaypointsToServer(mapName, pointA, pointB)
    if not isBeamMPAvailable() then
        log("Not in BeamMP mode, skipping server sync", "WARN")
        return false
    end
    
    local data = {
        event = "hotlapping_waypoints_update",
        mapName = mapName,
        pointA = {x = pointA.x, y = pointA.y, z = pointA.z},
        pointB = {x = pointB.x, y = pointB.y, z = pointB.z}
    }
    
    TriggerServerEvent("HotlappingEvent", jsonEncode(data))
    log("Waypoints sent to server for map: " .. mapName)
    return true
end

local function sendBestTimeToServer(mapName, time, vehicle)
    if not isBeamMPAvailable() then
        return false
    end
    
    local data = {
        event = "hotlapping_best_time",
        mapName = mapName,
        time = time,
        vehicle = vehicle
    }
    
    TriggerServerEvent("HotlappingEvent", jsonEncode(data))
    log(string.format("Best time sent: %.3fs on %s", time, mapName))
    return true
end
```

### Получение данных от сервера (клиент)

```lua
local function onServerDataReceived(data)
    local decoded = jsonDecode(data)
    
    if decoded.event == "hotlapping_waypoints_sync" then
        -- Получили точки от сервера
        local pointA = decoded.pointA
        local pointB = decoded.pointB
        
        if pointA and pointB and waypointManager then
            waypointManager.setPointA(pointA)
            waypointManager.setPointB(pointB)
            log("Waypoints synced from server")
            guihooks.message("Точки загружены с сервера", 3, "")
        end
        
    elseif decoded.event == "hotlapping_leaderboard_update" then
        -- Обновление лидерборда
        updateLeaderboard(decoded.leaderboard)
        log("Leaderboard updated from server")
    end
end

-- Регистрация обработчика
local function onExtensionLoaded()
    -- ... другая инициализация ...
    
    if isBeamMPAvailable() then
        -- Регистрируем обработчик событий от сервера
        AddEventHandler("HotlappingClientEvent", onServerDataReceived)
        
        -- Запрашиваем текущие данные
        requestDataFromServer()
    end
end
```

### Серверная часть (Lua плагин BeamMP)

Структура серверного плагина:
```
BeamMP-Server/Resources/Server/hotlapping/
├── main.lua              # Главный файл плагина
├── admins.json           # Список администраторов
├── waypoints_data.json   # Хранилище точек
├── leaderboard_data.json # Хранилище лидерборда
└── config.lua            # Конфигурация (опционально)
```

**admins.json:**
```json
{
  "admins": [
    "NikolasSnorkell",
    "AdminNickname",
    "ModeratorName"
  ]
}
```

**Основные серверные функции:**
- `loadAdminsFromFile()` - загрузка списка админов
- `isPlayerAdmin(playerID)` - проверка прав игрока по никнейму
- `sendAdminStatus(playerID)` - отправка статуса админа клиенту
- `loadWaypointsFromFile()` / `saveWaypointsToFile()` - работа с JSON точек
- `loadLeaderboardFromFile()` / `saveLeaderboardToFile()` - работа с JSON лидерборда
- `handleWaypointsUpdate(playerID, data)` - обработка установки точек (только админы)
- `handleBestTimeUpdate(playerID, data)` - обработка нового времени (все игроки)
- `broadcastWaypoints(mapName)` - рассылка точек всем клиентам
- `broadcastLeaderboard(mapName)` - рассылка лидерборда
- `validateWaypoints(pointA, pointB)` - валидация данных
- `sendDataToClient(playerID, mapName)` - отправка данных конкретному игроку

**Обработчик события подключения игрока:**
```lua
function onPlayerJoin(playerID)
    print("[Hotlapping] Player " .. playerID .. " joined")
    
    -- Проверяем, является ли игрок админом
    local isAdmin = isPlayerAdmin(playerID)
    
    -- Отправляем статус админа
    sendAdminStatus(playerID, isAdmin)
    
    -- Отправляем текущие данные (точки и лидерборд)
    local currentMap = MP.GetMapName()  -- Функция BeamMP API
    sendDataToClient(playerID, currentMap)
end
```

**Проверка прав при установке точек:**
```lua
function handleWaypointsUpdate(playerID, data)
    -- Проверка прав
    if not isPlayerAdmin(playerID) then
        local playerName = MP.GetPlayerName(playerID)
        print(string.format("[Hotlapping] Player %s tried to set waypoints without admin rights", playerName))
        return
    end
    
    -- ... обработка установки точек ...
end
```

---

## Примечания

- Начинаем с клиентской части (Client-side only)
- Мод работает только для локального игрока
- Фокус на простоте и производительности
- Минимальные зависимости от BeamJoy (берем только идеи и подходы)
- Код должен быть чистым и хорошо документированным

---

*Дата создания: 18 октября 2025*
*Последнее обновление: 19 октября 2025*
*Версия документа: 2.1*

---

## Итоговое резюме (19 октября 2025)

### ✅ Текущий статус:
- **MVP завершен:** Этапы 1-4 полностью реализованы
- **Работает:** Установка точек, детектирование пересечений, таймер, история кругов, ImGui UI
- **План утверждён:** Все архитектурные решения согласованы

### 📋 Принятые решения:

1. **Права доступа в BeamMP:**
   - ✅ Только администраторы из списка `admins.json`
   - ✅ Проверка по никнейму игрока
   - ✅ Условное отображение UI (админы видят кнопки, игроки - нет)

2. **Лидерборд:**
   - ✅ MVP: только лучшее время каждого игрока
   - ✅ v2.0: добавить режим "Recent laps" позже

3. **Уведомления:**
   - ✅ MVP: минимальные текстовые уведомления
   - ✅ v2.0: звуки при пересечении линии (референс из Chases_Mode)

4. **Хранение данных:**
   - ✅ Локально: полная история кругов игрока
   - ✅ На сервере: только лучшее время для лидерборда

5. **Множественные треки:**
   - ✅ v2.0: отложено, но держим в уме при проектировании
   - ✅ Структура данных должна допускать расширение

6. **Античит:**
   - ✅ Не требуется, только базовая валидация значений
   - ✅ Доверие игрокам

### 🎯 План реализации v1.0:

**Этап 5: LocalStorage (2-3 часа)**
- Создать StorageManager.lua
- Сохранение/загрузка точек по картам
- Сохранение истории кругов по картам
- Автозагрузка при старте карты

**Этап 6: BeamMP - Точки (4-6 часов)**
- Проверка MPGameNetwork.launcherConnected()
- Система админов (admins.json на сервере)
- Синхронизация точек
- Условное отображение UI кнопок

**Этап 7: BeamMP - Лидерборд (5-7 часов)**
- Отправка лучших времен
- Серверная обработка и хранение
- UI окно лидерборда (ImGui)
- Топ-100 с подсветкой своей позиции

**Этап 8: Debug режим (2-3 часа)**
- Галочка в UI
- Управление визуализацией
- Сохранение настройки

**Общая оценка:** 13-19 часов работы

### 🚀 Архитектура v1.0:

**Клиент:**
- Автоопределение режима (online/offline)
- Fallback на LocalStorage при отсутствии BeamMP
- Клиентская логика (пересечения, таймер)
- Минимальный сетевой трафик

**Сервер:**
- Список админов в admins.json
- Хранение точек в waypoints_data.json
- Хранение лидерборда в leaderboard_data.json
- Валидация данных
- Broadcast обновлений всем клиентам

**Принципы:**
- ✅ Работает без BeamMP (оффлайн)
- ✅ Плавная интеграция с BeamMP (онлайн)
- ✅ Минимальный трафик (только рекорды)
- ✅ Расширяемая архитектура (треки в v2.0)

### 📝 Готово к реализации:

Все архитектурные решения приняты. Можно начинать разработку с **Этапа 5 (LocalStorage)**.

**Следующий шаг:** Реализация StorageManager.lua для сохранения/загрузки данных локально.

